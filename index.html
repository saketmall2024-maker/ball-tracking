let src = new cv.Mat();
let hsv = new cv.Mat();
let mask = new cv.Mat();
let contours = new cv.MatVector();
let hierarchy = new cv.Mat();

function process() {

  if (video.readyState === 4) {

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    src = cv.imread(canvas);

    cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
    cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

    let lower = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [35,70,70,0]);
    let upper = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [85,255,255,255]);

    cv.inRange(hsv, lower, upper, mask);

    cv.findContours(mask, contours, hierarchy,
                    cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let maxArea = 0;
    let best = null;

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);
      let area = cv.contourArea(cnt);
      if (area > maxArea) {
        maxArea = area;
        best = cv.boundingRect(cnt);
      }
    }

    if (best && maxArea > 1000) {
      ctx.strokeStyle = "lime";
      ctx.lineWidth = 6;
      ctx.strokeRect(best.x, best.y, best.width, best.height);
    }

    lower.delete();
    upper.delete();
    src.delete();
  }

  requestAnimationFrame(process);
}
