<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Green Ball Traffic Control</title>
<style>
body { margin:0; overflow:hidden; background:black; }
video, canvas {
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ðŸ”´ PUT YOUR ESP32 IP HERE
const ESP_IP = "http://192.168.1.XXX/";

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => video.srcObject = stream);

video.addEventListener("loadeddata", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  track();
});

let lastCommand = "";

function sendCommand(cmd){
  if(cmd !== lastCommand){
    fetch(ESP_IP + cmd).catch(()=>{});
    lastCommand = cmd;
  }
}

function track(){
  ctx.drawImage(video,0,0);

  let frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  let data = frame.data;

  let left=0, center=0, right=0;

  for(let i=0;i<data.length;i+=4){
    let r=data[i], g=data[i+1], b=data[i+2];

    if(g > 150 && r < 100 && b < 100){
      let x = (i/4) % canvas.width;

      if(x < canvas.width/3) left++;
      else if(x < 2*canvas.width/3) center++;
      else right++;
    }
  }

  if(left>center && left>right) sendCommand("LEFT");
  else if(right>left && right>center) sendCommand("RIGHT");
  else if(center>left && center>right) sendCommand("CENTER");

  requestAnimationFrame(track);
}
</script>

</body>
</html>
